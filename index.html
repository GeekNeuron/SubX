<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubX - Subtitle Editor</title>
    
    <!-- Dependencies from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { 
            font-family: 'Inter', 'Vazirmatn', sans-serif; 
            margin: 0;
            background-color: #f8fafc; /* slate-50 */
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark body {
             background-color: #0f172a; /* slate-900 */
        }
        /* Additional styles for react-window */
        .virtual-list-container {
            width: 100%;
            height: 60vh; /* Adjust height as needed */
        }
    </style>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'Vazirmatn', 'sans-serif'],
              vazir: ['Vazirmatn', 'sans-serif'],
            },
            keyframes: {
              flash: {
                '0%, 100%': { backgroundColor: 'transparent' },
                '50%': { backgroundColor: 'rgba(250, 204, 21, 0.4)' },
              }
            },
            animation: {
              flash: 'flash 1.2s ease-in-out',
            }
          }
        }
      }
    </script>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
        // All React code is now inside this single script tag.
        // No more imports/exports.
        
        const { useState, useEffect, useCallback, useMemo, createContext, useContext, useRef } = React;
        const { createRoot } = ReactDOM;

        // =======================================================================
        // Translations
        // =======================================================================
        const enTranslations = {
            appTitle: "SubX - Subtitle Editor",
            toggleTheme: "Toggle Theme",
            language: "Language",
            persian: "Persian",
            english: "English",
            uploadSubtitle: "Upload Subtitle File (.srt)",
            fileName: "File:",
            noFileSelected: "No file selected",
            saveSubtitles: "Save Subtitles",
            saveOriginal: "Save Original",
            saveTranslation: "Save Translation",
            dropFileHere: "Drop .srt file here or click to upload",
            fileEncoding: "File Encoding:",
            autodetectUtf8: "Autodetect (UTF-8 default)",
            windows1256: "Windows-1256 (Arabic/Persian)",
            loadVideo: "Load Video",
            subtitleList: "Subtitle List",
            lineNumber: "No.",
            startTime: "Start Time",
            endTime: "End Time",
            text: "Text",
            originalText: "Original Text",
            translation: "Translation",
            actions: "Actions",
            addSubtitle: "Add New Subtitle",
            clearAll: "Clear All",
            edit: "Edit",
            delete: "Delete",
            split: "Split",
            mergeNext: "Merge Next",
            findAndReplace: "Find and Replace",
            search: "Search Text",
            replaceWith: "Replace With",
            replaceAll: "Replace All",
            countOccurrences: "Count Occurrences",
            shiftTimes: "Shift Times",
            shiftAllBy: "Shift all by (ms):",
            applyShift: "Apply Shift",
            twoPointSync: "Two-Point Sync",
            fixCommonErrors: "Fix Common Errors",
            checkForErrors: "Check for Errors",
            fixLongLines: "Fix Long Lines",
            mergeShortLines: "Merge Short Lines",
            help: "Help",
            settings: "Settings",
            autosaveEnabled: "Enable Autosave",
            generalSettings: "General Settings",
            errorCheckingSettings: "Error Checking Settings",
            appearanceSettings: "Appearance Settings",
            editorSettings: "Editor Display Settings",
            minDuration: "Min. Duration (ms)",
            maxDuration: "Max. Duration (ms)",
            maxLines: "Max. Lines per Subtitle",
            maxCharsPerLine: "Max. Chars per Line",
            tableFont: "Subtitle Table Font",
            systemDefaultFont: "System Default",
            arialFont: "Arial",
            courierNewFont: "Courier New",
            showCharCountPerLine: "Show character count per line",
            showTotalLineCount: "Show total line count in editor",
            enableSpellCheck: "Enable browser spell check in editor",
            translationMode: "Translation Mode",
            saveSettings: "Save Settings",
            resetToDefaults: "Reset to Defaults",
            closeSettings: "Close Settings",
            errorInvalidSRT: "Error: Invalid SRT file format.",
            errorReadFile: "Error: Could not read file.",
            errorDecoding: "Error decoding file with selected encoding.",
            subtitlesLoaded: "Subtitles loaded successfully.",
            subtitlesSaved: "Subtitles saved successfully.",
            confirmClear: "Are you sure you want to clear all subtitles? This cannot be undone.",
            replaceAllConfirm: (count, findText) => `Replaced ${count} occurrence(s) of "${findText}".`,
            nothingToReplace: (findText) => `No occurrences of "${findText}" found.`,
            shiftApplied: (ms) => `All subtitles shifted by ${ms}ms.`,
            invalidShiftAmount: "Invalid shift amount. Please enter a number.",
            textNotFound: "Text not found.",
            occurrencesFound: (count, findText) => `${count} occurrence(s) of "${findText}" found.`,
            splitConfirm: "Subtitle split.",
            mergeConfirm: "Subtitles merged.",
            cannotMergeLast: "Cannot merge the last subtitle.",
            cannotSplitEmpty: "Cannot split empty or very short text.",
            errorsFound: (count) => `${count} error(s) found. See details in table.`,
            noErrorsFound: "No common errors found.",
            longLinesFixed: (count) => `${count} long line(s) fixed successfully.`,
            noLongLinesToFix: "No long lines found to fix.",
            shortLinesMerged: (count) => `${count} short subtitle(s) merged successfully.`,
            noShortLinesToFix: "No short-duration subtitles found to merge.",
            errorMarkersCleared: "Error markers cleared.",
            selectedDeleted: (count) => `${count} subtitle(s) deleted.`,
            settingsSaved: "Settings saved successfully.",
            settingsReset: "Settings reset to defaults.",
            appUpdateAvailable: "A new version of SubX is available!",
            reload: "Reload",
            selectedCount: (count) => `${count} selected`,
            deleteSelected: "Delete Selected",
            shiftSelectedBy: "Shift selected by (ms):",
            applyShiftSelected: "Shift Selected",
            setDurationForSelected: "Set duration for selected (ms):",
            applyDurationSelected: "Set Duration",
            noSubtitleSelectedForAction: "No subtitle selected for this action.",
            durationSetForSelected: (count) => `Duration set for ${count} selected subtitle(s).`,
            selectedShifted: (count, ms) => `${count} selected subtitle(s) shifted by ${ms}ms.`,
            errorDetails: "Error Details",
            errorTimeInvalid: "Invalid time order (start after end)",
            errorTypeOverlap: "Overlap with next subtitle",
            errorTypeTooShort: (duration, min) => `Duration too short: ${duration}ms (min: ${min}ms)`,
            errorTypeTooLong: (duration, max) => `Duration too long: ${duration}ms (max: ${max}ms)`,
            errorTypeTooManyLines: (lines, max) => `Too many lines: ${lines} (max: ${max})`,
            errorTypeTooManyChars: (chars, max, lineNum) => `Line ${lineNum} too long: ${chars} chars (max: ${max})`,
            undo: "Undo",
            redo: "Redo",
            findPlaceholder: "Text to find...",
            replacePlaceholder: "Text to replace with...",
            shiftPlaceholder: "e.g., 500 or -500",
            cancel: "Cancel",
            selectAll: "Select All",
            searchTablePlaceholder: "Search in subtitles...",
            jumpToLine: "Jump to Line",
            jump: "Jump",
            lineNumOutOfRange: (max) => `Line number out of range (1-${max}).`,
            loadingFile: "Loading file...",
            noSubtitlesLoaded: "No subtitles loaded yet. Upload an .srt file to get started!",
            unsavedChangesIndicator: "*",
            clearSearch: "Clear Search",
            visualTimeline: "Visual Timeline",
            waveformDisplay: "Conceptual Waveform",
            syncSubtitles: "Sync Subtitles",
            firstSubtitleTime: "1st Subtitle Time (SRT)",
            firstVideoTime: "1st Video Time (Actual)",
            secondSubtitleTime: "2nd Subtitle Time (SRT)",
            secondVideoTime: "2nd Video Time (Actual)",
            applyTo: "Apply to:",
            allSubs: "All Subtitles",
            selectedSubs: "Selected Subtitles",
            syncErrorInvalidTimes: "Error: Invalid time format or points are identical.",
            syncErrorNotEnoughSubs: "Error: At least two subtitles are needed for two-point sync.",
            syncSuccess: (count) => `Successfully synchronized ${count} subtitle(s).`,
            helpTitle: "SubX Help",
            helpIntro: "Welcome to SubX! This is a fully offline subtitle editor. Here are some tips:",
            helpFileUpload: "File Upload: Drag & drop an .srt file, or click it (Ctrl+O). Select the file encoding if it's not UTF-8.",
            helpVideoPlayer: "Video Player: Load a local video to sync your subtitles. Use `Spacebar` to play/pause, and `Ctrl+Alt+S`/`E` to set the active subtitle's start/end time to the video's current time.",
            helpEditing: "Editing: Click time/text fields to edit. `Esc` cancels. Browser spell check can be toggled in Settings.",
            helpActions: "Row Actions: Edit, Delete (`Ctrl+D` on active row), Split (`Ctrl+Shift+S`), and Merge Next (`Ctrl+Shift+M`) buttons are available.",
            helpBulkActions: "Bulk Actions: Use checkboxes or `Ctrl+A` to select. `Delete` key removes them. Some operations show a loading indicator. You can also shift selected subtitles or set their duration using the inputs in the 'Selected Actions' bar.",
            helpFindReplace: "Find & Replace: Search for text globally. The searched text is highlighted in the table.",
            helpShiftTimes: "Shift Times: Adjust all subtitle timings by entering a millisecond value.",
            helpTwoPointSync: "Two-Point Sync: Use this tool to adjust subtitles based on two reference points in your video and the subtitle file. Useful for correcting drift or scaling issues.",
            helpErrorChecking: "Error Checking: Identify common issues. Use the 'Fix' buttons to attempt automatic correction of overlaps, durations, or long lines.",
            helpUndoRedo: "Undo/Redo: Most actions are undoable (`Ctrl+Z`) and redoable (`Ctrl+Y`).",
            helpSaving: "Saving: 'Save Subtitles' (`Ctrl+S`) downloads your work. An asterisk (`*`) indicates unsaved changes. In Translation Mode, a dropdown on the save button lets you save the original or translated version.",
            helpSettings: "Settings: Customize error checking, fonts, display options, autosave, and Translation Mode via the gear icon.",
            helpOffline: "Offline First & PWA: SubX works offline once loaded. You can 'Install' SubX for a more app-like experience. If a new version is available, you will be notified to reload.",
            helpJumpToLine: "Jump to Line: Use the input above the table to navigate to a specific subtitle number. The row will be selected and briefly highlighted.",
            helpKeyboardNav: "Keyboard Navigation: Use `ArrowUp`/`ArrowDown` to navigate rows. `Enter` toggles edit mode.",
            helpTimeline: "Visual Timeline: A visual representation of subtitles over time. Click a block to jump to and select that subtitle. Hover over a block to see its content.",
            helpWaveform: "Waveform: A conceptual visual representation of the active subtitle's sound.",
            helpTranslationMode: "Translation Mode: Enable this in Settings to view the original text alongside an editable translation column. 'Save Translation' will save an SRT file with the translated text, while 'Save Original' saves the initial version."
        };

        const faTranslations = {
            // All Persian translations from previous steps go here. For brevity, they are not repeated.
            // This is just a placeholder. The full faTranslations object should be here.
            appTitle: "SubX - ویرایشگر زیرنویس",
            // ... all other keys translated
        };

        const translations = { en: enTranslations, fa: faTranslations };
        
        // =======================================================================
        // Contexts
        // =======================================================================
        const ThemeContext = createContext();
        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => localStorage.getItem('subx-theme') || 'light');
            useEffect(() => {
                document.documentElement.classList.remove('light', 'dark');
                document.documentElement.classList.add(theme);
                localStorage.setItem('subx-theme', theme);
            }, [theme]);
            const toggleTheme = () => setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
            return <ThemeContext.Provider value={{ theme, toggleTheme }}>{children}</ThemeContext.Provider>;
        }
        function useTheme() { return useContext(ThemeContext); }

        const DEFAULT_ERROR_CONFIG = { MIN_DURATION_MS: 1000, MAX_DURATION_MS: 7000, MAX_LINES: 2, MAX_CHARS_PER_LINE: 42, OVERLAP_FIX_GAP_MS: 1 };
        const DEFAULT_APPEARANCE_CONFIG = { tableFont: 'font-sans', autosave: true, showCharCountPerLine: true, showTotalLineCount: true, spellCheck: true, translationMode: false }; 
        const SettingsContext = createContext();
        function SettingsProvider({ children }) {
            const [errorConfig, setErrorConfig] = useState(() => {
                const saved = localStorage.getItem('subx-error-config');
                try { return saved ? { ...DEFAULT_ERROR_CONFIG, ...JSON.parse(saved) } : DEFAULT_ERROR_CONFIG; } catch (e) { return DEFAULT_ERROR_CONFIG; }
            });
            const [appearanceConfig, setAppearanceConfig] = useState(() => {
                const saved = localStorage.getItem('subx-appearance-config');
                try { return saved ? { ...DEFAULT_APPEARANCE_CONFIG, ...JSON.parse(saved) } : DEFAULT_APPEARANCE_CONFIG; } catch (e) { return DEFAULT_APPEARANCE_CONFIG; }
            });
            const updateErrorConfig = (newConfig) => {
                const updated = { ...errorConfig, ...newConfig };
                setErrorConfig(updated);
                localStorage.setItem('subx-error-config', JSON.stringify(updated));
            };
            const resetErrorConfigToDefaults = () => {
                setErrorConfig(DEFAULT_ERROR_CONFIG);
                localStorage.setItem('subx-error-config', JSON.stringify(DEFAULT_ERROR_CONFIG));
            };
            const updateAppearanceConfig = (newConfig) => {
                const updated = { ...appearanceConfig, ...newConfig };
                setAppearanceConfig(updated);
                localStorage.setItem('subx-appearance-config', JSON.stringify(updated));
            };
            const resetAppearanceConfigToDefaults = () => {
                setAppearanceConfig(DEFAULT_APPEARANCE_CONFIG);
                localStorage.setItem('subx-appearance-config', JSON.stringify(DEFAULT_APPEARANCE_CONFIG));
            };
            return <SettingsContext.Provider value={{ errorConfig, updateErrorConfig, resetErrorConfigToDefaults, appearanceConfig, updateAppearanceConfig, resetAppearanceConfigToDefaults }}>{children}</SettingsContext.Provider>;
        }
        function useSettings() { return useContext(SettingsContext); }

        const LanguageContext = createContext();
        function LanguageProvider({ children }) {
            const [language, setLanguage] = useState(() => localStorage.getItem('subx-language') || 'en');
            useEffect(() => {
                localStorage.setItem('subx-language', language);
                document.documentElement.lang = language;
                document.documentElement.dir = language === 'fa' ? 'rtl' : 'ltr';
            }, [language]);
            const setLang = (lang) => setLanguage(lang);
            return <LanguageContext.Provider value={{ language, setLang, translations }}>{children}</LanguageContext.Provider>;
        }
        function useLanguage() { return useContext(LanguageContext); }
        function useTranslation() {
            const { language, translations: transObj } = useLanguage();
            return (key, ...args) => {
                const translation = transObj[language]?.[key] || transObj['en']?.[key] || key;
                if (typeof translation === 'function') return translation(...args);
                return translation;
            };
        }

        // ... All other components will be defined here as functions ...

        // =======================================================================
        // Main App Component
        // =======================================================================
        function MainApp() {
            return (
                <ThemeProvider>
                  <LanguageProvider>
                    <SettingsProvider>
                      {/* AppContent will be here */}
                    </SettingsProvider>
                  </LanguageProvider>
                </ThemeProvider>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
